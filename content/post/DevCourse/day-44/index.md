+++
author = "Seorim"
title =  "Day 44 Airflow(3)"
slug = "day-44"
date = 2023-12-14T12:07:41+09:00

categories = [
    "DevCourse",
]
tags = [
    "TIL", "Airflow", "Backfill"
]
+++

<style>
g1 { color: #79AC78 }
g2 { color: #B0D9B1 }
g3 { color: #D0E7D2 }
g4 { color: #618264 }
o1 { color: #F9B572 }
w1 { color: #FAF8ED }
</style>

# ğŸ“‹Â ê³µë¶€ ë‚´ìš©

## Airflow ì‹¤ìŠµ : DAG êµ¬í˜„í•˜ê¸°

## Primary Key Uniqueness ë³´ì¥í•˜ê¸°

### í€´ì¦ˆ

```python
# Weather_to_Redshift_v2.py

INSERT INTO {schema}.{table}
SELECT date, temp, min_temp, max_temp FROM (
SELECT *, ROW_NUMBER() OVER (PARTITION BY date ORDER BY created_date DESC) seq
FROM t
)
WHERE seq = 1;
```

> ì—¬ê¸°ì„œ transactionìœ¼ë¡œ ì²˜ë¦¬ë˜ì–´ì•¼ í•˜ëŠ” ìµœì†Œ ë²”ìœ„ì˜ SQLë“¤ì€?

### Upsert

> Insert & Update

-   primary keyë¥¼ ê¸°ì¤€ìœ¼ë¡œ
    -   ì¡´ì¬í•˜ëŠ” ë ˆì½”ë“œë¼ë©´, ìƒˆ ì •ë³´ë¡œ ìˆ˜ì •
    -   ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë ˆì½”ë“œë¼ë©´ ìƒˆ ë ˆì½”ë“œ ì ì¬
-   DWë§ˆë‹¤ UPSERTë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ì‹¤í–‰í•´ì£¼ëŠ” ë¬¸ë²•ì„ ì§€ì›í•´ì¤Œ
    -   [ìì„¸í•œ ì„¤ëª…](#mysql-to-redshift-dag)

## Backfill

> ë°ì´í„°ë¥¼ ì½ì–´ì˜¤ëŠ” ë° ì‹¤íŒ¨í•˜ê±°ë‚˜, ì½ì–´ì˜¨ ë°ì´í„°ì˜ ë¬¸ì œ ë•Œë¬¸ì— ë°ì´í„° íŒŒì´í”„ë¼ì¸ì„ ì¬ì‹¤í–‰í•˜ì—¬ ë‹¤ì‹œ ì½ì–´ì™€ì•¼ í•˜ëŠ” ê³¼ì •

### Incremental Update ì‹¤íŒ¨

-   í•˜ë£¨ì— í•œ ë²ˆ ë™ì‘í•˜ëŠ” incremental update
-   ì¤‘ê°„ì— ë©°ì¹ ë™ì•ˆ ì´ ê³¼ì •ì´ ì‹¤íŒ¨í•œ ê²½ìš°, ê·¸ ì´í›„ì˜ ì‹¤í–‰ì—ë„ ì˜í–¥ì„ ì£¼ê²Œ ë˜ì–´ìˆìŒ
-   ì‹¤íŒ¨í•œ ë¶€ë¶„ì„ ì¬ì‹¤í–‰ -> ì–¼ë§ˆë‚˜ ì¤‘ìš”í•œê°€?

### Backfillì˜ ìš©ì´ì„±

> <o1>ì‹¤íŒ¨í•œ ë°ì´í„° íŒŒì´í”„ë¼ì¸ì˜ ì¬ì‹¤í–‰</o1>ì´ ì–¼ë§ˆë‚˜ ìš©ì´í•œ êµ¬ì¡°ì¸ê°€?

-   full refresh

    -   ë¬¸ì œê°€ ìƒê¸°ë©´ ë‹¤ì‹œ ì‹¤í–‰í•˜ë©´ ë¨
    -   backfill ë¶ˆí•„ìš”

-   Incremental Update
    -   ë°ì´í„°ë¥¼ ë‹¤ì‹œ ì½ì–´ì™€ì•¼ í•˜ë©´ ì²˜ìŒë¶€í„° ëª¨ë‘ ë‹¤ ì¬ì‹¤í–‰í•´ì•¼ í•¨ ( íš¨ìœ¨ì„±ì€ ë” ì¢‹ì„ ìˆ˜ ìˆì§€ë§Œ, ìš´ì˜&ìœ ì§€ë³´ìˆ˜ê°€ ì–´ë ¤ì›Œì§)
    -   backfill í•„ìš”

> Airflow : backfillì„ ì‰½ê²Œ í•  ìˆ˜ ìˆë„ë¡ ë””ìì¸ë¨

### Backfill of Daily DAG

#### Daily DAG

-   ì§€ê¸ˆ ì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ ì–´ì œ ë‚ ì§œë¥¼ ê³„ì‚°, ì–´ì œ ë°ì´í„°ë¥¼ ì½ì–´ì˜´
-   ë§¤ì¼ ë¬¸ì œ ì—†ì´ ë™ì‘í•˜ë©´ OK, BUT ë°ì´í„° ì½ì–´ì˜¤ê¸°ì— ì‹¤íŒ¨í•˜ëŠ” ê²½ìš° ? -> íŠ¹ì • ë‚ ì§œì˜ ë°ì´í„°ê°€ ë¹ ì ¸ìˆìŒ -> ì‹¤íŒ¨í•œ ë‚  ê¸°ì¤€ìœ¼ë¡œ ì „ë‚ ì˜ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸ í•˜ëŠ” ì½”ë“œë¥¼ ìƒˆë¡œ ì‘ì„±í•´ì•¼ í•¨ (ì›í•˜ëŠ” ë‚ ì§œë¥¼ í•˜ë“œì½”ë”©í•˜ëŠ” ë°©ì‹)

    ```python
    from datetime import datetime, timedelta
    # y = datetime.now() - timedelta(1)
    # yesterday = datetime.strftime(y, '%Y-%m-%d')
    yesterday = '2023-01-01'
    ```

-   ì‹¤ìˆ˜í•˜ê¸° ì‰½ê³  ìˆ˜ì •í•˜ëŠ” ë° ì‹œê°„ì´ ë§ì´ ê±¸ë¦¼

**`DAGë¥¼ ìƒì„±í•  ë•Œ ë¶€í„° backfillì„ ì‰½ê²Œ ë§Œë“¤ì–´ì•¼ í•¨`**

### Backfillì„ ìš©ì´í•˜ê²Œ í•˜ëŠ” êµ¬ì¡°

-   ë‚ ì§œë³„ë¡œ backfill ê²°ê³¼ë¥¼ ê¸°ë¡
-   ë‚ ì§œëŠ” ì‹œìŠ¤í…œì—ì„œ ETL ì¸ìë¡œ ì œê³µ
-   ë‚ ì§œë¥¼ ë”°ë¡œ ê³„ì‚°í•˜ì§€ ì•Šê³ , ì‹œìŠ¤í…œì´ ì •í•´ì¤€ ë‚ ì§œë¥¼ ì‚¬ìš©

#### Airflowì˜ êµ¬ì¡°

-   ETLë³„ë¡œ ì‹¤í–‰ë‚ ì§œ, ê²°ê³¼ë¥¼ ë©”íƒ€ë°ì´í„° DBì— ê¸°ë¡
-   ëª¨ë“  DAG ì‹¤í–‰ì— `execution_date` ì§€ì •
-   `execution_date`ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë°ì´í„°ë¥¼ ê°±ì‹ í•˜ë„ë¡ ì½”ë“œ ì‘ì„±

## DAG Parameter

### date ê´€ë ¨ parameter ì •ë¦¬

[Daily Incremental Update](#daily-dag) êµ¬í˜„

#### start_date

-   2020-11-07ì˜ ë°ì´í„°ë¥¼ ì½ì–´ì˜´
-   2020-11-08 ë¶€í„° ETL ë™ì‘

    -> start_date : 2020-11-07

## MySQL to Redshift DAG

# ğŸ‘€Â CHECK

_<span style = "font-size:15px">(ì–´ë µê±°ë‚˜ ìƒˆë¡­ê²Œ ì•Œê²Œ ëœ ê²ƒ ë“± ë‹¤ì‹œ í™•ì¸í•  ê²ƒë“¤)</span>_

### openweathermap api

-   https://openweathermap.org/api/one-call-3
-   êµ¬ë…í•œ ì´í›„ì— ë°”ë¡œ í—ˆê°€ê°€ ì•ˆë˜ëŠ” ë¬¸ì œê°€ ìˆìŒ..
-   ê¸°ì¡´ ì½”ë“œë¥¼ 2.5 -> 3.0 ìœ¼ë¡œ ë°”ê¿”ì•¼ í•¨

# â— ëŠë‚€ ì 
